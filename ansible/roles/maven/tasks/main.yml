---

- name: Define apps_dir
  set_fact:
    apps_dir: "{{ apps_dir }}"
  when: apps_dir is undefined

- stat:
    path: "{{ apps_dir }}/apache-maven-{{ maven.version }}"
  register: maven_dir

- debug:
    msg: "maven_dir = {{ maven_dir.stat.isdir }}"
  when: maven_dir.stat.isdir is defined

- name: "Create {{ apps_dir }} directory"
  file:
    path: "{{ apps_dir }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: directory
  become: yes

- block:

  - name: get Maven tarball
    get_url:
      url: "{{maven.url}}"
      dest:    "/tmp/apache-maven-{{ maven.version }}-bin.tar.gz"

  - name: Unarchive maven
    unarchive:
      src: "/tmp/apache-maven-{{ maven.version }}-bin.tar.gz"
      dest: "{{apps_dir}}"
      copy: no

  when: maven_dir.stat.isdir is not defined


- name: Remove old symlink
  file:
    path: "{{apps_dir}}/maven"
    state: absent

- file:
    src: "{{apps_dir}}/apache-maven-{{ maven.version }}"
    dest: "{{apps_dir}}/maven"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    state: link

- name: Remove old path configuration
  file:
    path: /etc/profile.d/maven.sh
    state: absent
  become: yes

- name: "Configuring maven home {{apps_dir}}/apache-maven-{{maven.version}} and add $PATH."
  template:
    src: maven.sh.j2
    dest: /etc/profile.d/maven.sh
    mode: 0644
  become: yes
